# Markdown Inline Preview 拡張機能仕様書

本仕様書は、VSCode拡張機能「Markdown Inline Preview」の包括的な技術文書です。
プロジェクトの背景、解決したい課題、機能仕様、技術的実装、設定項目、変更履歴など、
開発・保守・利用に必要な全ての情報を体系的に記載しています。

## 背景と目的

### プロジェクトの背景
現代のナレッジワーカーは、日々大量のテキスト情報を扱い、タスク管理やドキュメント作成を行っています。
Obsidian、Notion といったモダンなノートアプリケーションは、Markdown の簡潔性を保ちながら、
リアルタイムプレビューと WYSIWYG（What You See Is What You Get）に近い直感的な編集体験を提供しています。

しかし、開発者が最も多くの時間を過ごす VSCode では、標準的な Markdown 編集機能は存在するものの、
エディタ内でのインラインプレビューや、これらのアプリケーションが提供するような洗練された編集体験は得られません。
「Markdown Inline Preview」は、この課題を解決し、VSCode内で直接的な視覚フィードバックを提供します。

### 解決したい課題
1. **チェックボックスの操作性の問題**
   - テキスト選択時の誤クリックによる意図しないチェック
   - 編集中の視認性の低下
   - タスク完了後の整理の手間

2. **テキスト編集の効率性の問題**
   - Markdown 記法を意識した選択・編集操作の欠如
   - リスト項目や見出しの編集時の不便さ
   - コピー&ペースト時の記法の扱い

3. **視覚的フィードバックの不足**
   - 完了タスクの区別がつきにくい
   - 編集中と閲覧時の表示の一貫性不足

## 主要機能

### 1. チェックボックスの装飾と操作

#### 1.1 視覚的フィードバック
- **完了タスクの表示**
  - `- [x]` および `- [X]` の行に横線（strikethrough）を適用
  - テキスト部分のみに装飾（チェックボックス自体は除外）
  - 透明度60%のグレー色（rgba(136, 136, 136, 0.6)）で表示
  - `!important` フラグで他の装飾より優先

- **編集中の動作**
  - カーソルがある行を編集中は横線を一時的に非表示
  - 編集完了後（カーソルが別の行に移動）に装飾を再適用
  - 理由：編集時の視認性向上とテキスト選択の正確性確保

#### 1.2 クリック操作
- **クリック可能範囲**
  - チェックボックス記号部分（`[` と `]` の間）のみクリック可能
  - テキスト部分はクリック無効（誤操作防止）
  - ドラッグ選択中はクリック判定を無効化
  - 理由：コピー操作時の誤チェック防止

- **トグル動作**
  - `- [ ]` → `- [x]`：未完了→完了
  - `- [x]` または `- [X]` → `- [ ]`：完了→未完了
  - **チェック解除時の改善**：カーソルを `]` の後のスペースに配置
    - 連続してテキスト入力可能
    - 再度チェックを外す操作がスムーズ

### 2. タスク管理機能

#### 2.1 自動並び替え（改善版）
- **チェック時の動作**
  - 完了タスク（`- [x]`）を同一階層の未完了タスクグループの後へ移動
  - 完了タスクグループの先頭に配置

- **チェック解除時の動作**
  - 未完了タスク（`- [ ]`）を同一階層の完了タスクグループの前へ移動
  - 未完了タスクグループの最後に配置

- **グループ管理**
  ```markdown
  # 並び替えの例
  
  ## 初期状態
  - [ ] タスクA
  - [x] タスクB（完了済み）
  - [ ] タスクC
  - [x] タスクD（完了済み）
  
  ## タスクCをチェック後
  - [ ] タスクA
  - [x] タスクB（完了済み）
  - [x] タスクD（完了済み）
  - [x] タスクC ← 完了グループの最後へ
  
  ## タスクBのチェックを外した後
  - [ ] タスクA
  - [ ] タスクB ← 未完了グループの最後へ
  - [x] タスクD（完了済み）
  - [x] タスクC
  ```

- **設定項目**
  - `obsidianMarkdown.autoMoveCompletedTasks`：デフォルトは `false`
  - ネストされたリストの階層は維持
  - 空行で区切られたリストは別グループとして扱う

#### 2.2 階層管理
- **インデント操作**
  - Tab：インデントを増やす（子タスク化）
  - Shift+Tab：インデントを減らす（親タスク化）
  - リスト構造を保持しながら移動
  - チェックボックス、箇条書き、番号付きリストに対応

### 3. 見出しの視覚的装飾（新機能）

#### 3.1 見出しレベル別スタイリング
- **H1〜H6の階層表現**
  - 各レベルに異なる色、太さ、背景色、ボーダーを適用
  - H1：最も太く目立つ赤系色（#e06c75）
  - H2：オレンジ系（#d19a66）
  - H3：黄色系（#e5c07b）
  - H4：緑系（#98c379）
  - H5：水色系（#56b6c2）
  - H6：青系（#61afef）

- **技術的制限と対策**
  - VSCode APIの制限によりフォントサイズは変更不可
  - 代替として以下の視覚要素で階層を表現：
    - fontWeight：900（H1）から700（H6）まで段階的に変化
    - backgroundColor：透明度6%の背景色
    - border：透明度30%のボーダー
    - borderRadius：3pxで角を丸める

- **編集時の維持**
  - 編集中も見出し装飾は維持される（チェックボックスの横線とは異なる動作）
  - `rangeBehavior: ClosedClosed`で範囲を保持

### 4. スマートテキスト選択

#### 4.1 スマート選択機能
- **Cmd+Left / Ctrl+Left**
  - Markdown 要素の直後にカーソル移動
  - 対応要素：
    - 見出し（`# `, `## `, ... `###### `）
    - チェックボックス（`- [ ] `, `- [x] `）
    - 箇条書き（`- `, `* `, `+ `）
    - 番号付きリスト（`1. `, `2. `, ...）
    - 引用（`> `）
    - コードブロック開始（` ``` `）

- **Shift+Cmd+Left / Shift+Ctrl+Left**
  - Markdown 要素の直後から行末までを選択
  - コピー操作に最適化
  - 記法部分を除いたコンテンツのみ選択可能

#### 4.2 コードブロック内選択
- **Cmd+A / Ctrl+A**
  - コードブロック内でのみコードを選択
  - ` ``` ` マーカーは除外
  - 通常のテキストでは標準の全選択動作

### 5. ドラッグ選択時の保護

#### 5.1 誤操作防止
- **ドラッグ状態の検知**
  - マウスによる選択開始を検知
  - 選択範囲が空でない場合はドラッグ中と判定
  - ドラッグ終了まではチェックボックスのクリック判定を無効化

- **利点**
  - テキストコピー時の誤チェック防止
  - 複数行選択時の安全性向上
  - 編集操作の信頼性向上

## 技術仕様

### アーキテクチャ
- **装飾管理**
  - 単一の `TextEditorDecorationType` を再利用（パフォーマンス最適化）
  - 範囲配列を一括更新（ちらつき防止）
  - デバウンス処理（50ms）で頻繁な更新を抑制

### イベント処理
1. **onDidChangeTextDocument**
   - テキスト変更を検知
   - デバウンス処理で効率化

2. **onDidChangeTextEditorSelection**
   - 選択・クリックを検知
   - 編集行の追跡
   - ドラッグ状態の管理

3. **onDidChangeActiveTextEditor**
   - エディタ切り替えを検知
   - 装飾の再適用

### 状態管理
- `checkedDecoration`：装飾タイプのグローバル管理
- `headingDecorations`：見出し装飾タイプの配列（6要素）
- `currentEditingLine`：編集中の行番号追跡
- `isDragging`：ドラッグ選択状態のフラグ
- `updateTimer`：デバウンス用タイマー

### パフォーマンス考慮事項
- 装飾の作成・破棄を最小化
- 必要な範囲のみ更新
- 大規模ファイルでも高速動作
- メモリリークの防止（適切なdispose処理）

## 設定項目

```json
{
  "obsidianMarkdown.autoMoveCompletedTasks": false,      // 完了タスクの自動移動
  "obsidianMarkdown.hideStrikethroughOnEdit": true,      // 編集中の横線非表示
  "obsidianMarkdown.checkboxClickableArea": "checkbox",  // クリック可能範囲
  "obsidianMarkdown.enableHeadingDecorations": true,     // 見出し装飾の有効化
  "obsidianMarkdown.headingColorScheme": "default"       // 見出しのカラースキーム
}
```

### 設定項目の詳細
- **autoMoveCompletedTasks**
  - タイプ：boolean
  - デフォルト：false
  - 説明：チェック/解除時にタスクを自動的に並び替え

- **hideStrikethroughOnEdit**
  - タイプ：boolean
  - デフォルト：true
  - 説明：編集中の行の横線装飾を一時的に非表示

- **checkboxClickableArea**
  - タイプ：string
  - デフォルト："checkbox"
  - オプション："checkbox" | "full-line"
  - 説明：チェックボックスのクリック可能範囲

- **enableHeadingDecorations**
  - タイプ：boolean
  - デフォルト：true
  - 説明：見出しの視覚的装飾を有効化

- **headingColorScheme**
  - タイプ：string
  - デフォルト："default"
  - オプション："default" | "monochrome" | "vibrant"
  - 説明：見出し装飾のカラースキーム

## キーバインディング

| コマンド | キー（Mac） | キー（Windows/Linux） | 説明 |
|---------|------------|---------------------|------|
| Toggle Checkbox | Cmd+Enter | Ctrl+Enter | チェックボックスの切り替え |
| Smart Select Left | Cmd+Left | Ctrl+Left | 要素の後にカーソル移動 |
| Smart Select Left | Shift+Cmd+Left | Shift+Ctrl+Left | 要素の後から行末まで選択 |
| Smart Select All | Cmd+A | Ctrl+A | コンテキストに応じた全選択 |
| Increase Indent | Tab | Tab | インデント増加 |
| Decrease Indent | Shift+Tab | Shift+Tab | インデント減少 |

## ユーザーシナリオ

### シナリオ1：効率的なタスク管理
1. ユーザーが朝のタスクリストを作成
2. 完了したタスクをクリックでチェック
3. タスクが自動的に下部へ移動し、未完了タスクが上部に残る
4. チェックを外すと、すぐにテキスト入力可能な状態になる

### シナリオ2：安全なテキスト編集
1. ユーザーが複数行のタスクをコピーしたい
2. ドラッグで選択中、チェックボックス上を通過
3. チェックボックスは反応せず、安全に選択完了
4. Shift+Cmd+Leftで記法を除いたテキストのみ選択可能

### シナリオ3：快適な編集体験
1. 完了タスクの編集時、横線が消えて編集しやすい
2. Cmd+Leftで素早く内容部分へジャンプ
3. コードブロック内でCmd+Aを押すとコード部分のみ選択

## 今後の拡張予定
- タスクの優先度表示（高/中/低）
- 期限管理機能（日付の自動認識）
- タグによるフィルタリング
- 進捗バーの表示
- カスタムチェックボックススタイル
- 統計情報の表示（完了率など）

## 変更履歴

### Version 1.2.1 - 最新改善
- ドラッグ選択中のチェックボックス誤反応を防止
- チェック解除時のカーソル位置を最適化
- タスクの並び替えロジックを改善（未完了/完了グループ管理）
- スマート選択機能を追加（Cmd+Left、Shift+Cmd+Left）
- 編集中の横線非表示機能を実装
- 見出しの視覚的装飾を追加（H1-H6で異なる色・太さ・背景）
- チェック/解除両方でカーソル位置を設定

### Version 1.2.0
- 基本的なチェックボックス装飾機能
- クリックによるトグル機能
- タスクの自動移動機能（基本版）